<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>กราฟข้อมูลแร่ธาตุและความชื้นของต้นกล้า</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient("https://jwjzrzrzcoizxikndkbn.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp3anpyenJ6Y29penhpa25ka2JuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE0OTE4NzMsImV4cCI6MjA3NzA2Nzg3M30.mW3EBI14n5zolnwfxr0EFFq42tGBg5hAij7GhDWwxMk");

    async function requireAuth() {
      const { data: { session } } = await supabase.auth.getSession();
      if (!session?.user) {
        alert('กรุณาเข้าสู่ระบบก่อน');
        window.location.href = 'login.html';
        return null;
      }
      return session.user;
    }

    async function getUsername(uid) {
      const { data } = await supabase.from('profiles').select('username').eq('user_id', uid).maybeSingle();
      return data?.username;
    }

    async function fetchRows(user_id) {
      const { data, error } = await supabase
        .from('readings')
        .select('date, mineral, moisture, n_mineral, n_moisture')
        .eq('user_id', user_id)
        .order('date', { ascending: true })
        .limit(90);
      if (error) { console.error(error); return []; }
      return data || [];
    }

    async function upsertToday(user_id, values) {
      // Ensure YYYY-MM-DD (UTC date)
      const d = new Date(); const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().slice(0,10);
      const row = { user_id, date, ...values };
      const { error } = await supabase
        .from('readings')
        .upsert(row, { onConflict: 'user_id,date' });
      if (error) throw error;
    }

    function toLabels(rows) { return rows.map(r => r.date); }
    function toNums(rows, key) { return rows.map(r => r[key]); }

    document.addEventListener('DOMContentLoaded', async () => {
      const user = await requireAuth();
      if (!user) return;

      const uname = await getUsername(user.id);
      document.getElementById('userBtn').textContent = "ผู้ใช้: " + (uname || user.email || user.id);

      // logout
      document.getElementById('logoutBtn').addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.href = 'login.html';
      });

      // charts
      const lineCtx = document.getElementById('lineChart').getContext('2d');
      const barCtx = document.getElementById('barChart').getContext('2d');

      let rows = await fetchRows(user.id);
      let labels = toLabels(rows);
      const lineData = {
        labels,
        datasets: [
          { label: 'ค่าแร่ธาตุ (Mineral)', data: toNums(rows, 'mineral'), borderWidth: 2, fill: false },
          { label: 'ค่าความชื้น (Moisture)', data: toNums(rows, 'moisture'), borderWidth: 2, fill: false }
        ]
      };
      const barData = {
        labels,
        datasets: [
          { label: 'จำนวนครั้งเติมแร่ธาตุต่อวัน', data: toNums(rows, 'n_mineral') },
          { label: 'จำนวนครั้งรดน้ำต่อวัน', data: toNums(rows, 'n_moisture') }
        ]
      };

      const lineChart = new Chart(lineCtx, { type: 'line', data: lineData, options: { responsive: true } });
      const barChart = new Chart(barCtx, { type: 'bar', data: barData, options: { responsive: true } });

      // form submit
      document.getElementById('dataForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const mineral = document.getElementById('mineral').value;
        const moisture = document.getElementById('moisture').value;
        const nMineral = document.getElementById('nMineral').value;
        const nMoisture = document.getElementById('nMoisture').value;
        if (!mineral && !moisture && !nMineral && !nMoisture) return;

        const vals = {
          mineral: mineral ? parseFloat(mineral) : null,
          moisture: moisture ? parseFloat(moisture) : null,
          n_mineral: nMineral ? parseInt(nMineral) : null,
          n_moisture: nMoisture ? parseInt(nMoisture) : null
        };

        try {
          await upsertToday(user.id, vals);
          rows = await fetchRows(user.id);
          lineChart.data.labels = toLabels(rows);
          lineChart.data.datasets[0].data = toNums(rows, 'mineral');
          lineChart.data.datasets[1].data = toNums(rows, 'moisture');
          barChart.data.labels = toLabels(rows);
          barChart.data.datasets[0].data = toNums(rows, 'n_mineral');
          barChart.data.datasets[1].data = toNums(rows, 'n_moisture');
          lineChart.update(); barChart.update();
          document.getElementById('dataForm').reset();
        } catch(err) {
          alert('บันทึกไม่สำเร็จ: ' + err.message);
        }
      });

      document.getElementById('cancelBtn').addEventListener('click', () => document.getElementById('dataForm').reset());
    });
  </script>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <h2 class="text-2xl font-bold text-center mb-6 text-blue-800">
    กราฟข้อมูลแร่ธาตุและความชื้นของแปลงต้นกล้า
  </h2>

  <div class="absolute right-0 top-0 flex space-x-2 m-2">
    <button id="userBtn" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg cursor-default">
      ผู้ใช้:
    </button>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
      ออกจากระบบ
    </button>
  </div>

  <form id="dataForm" class="max-w-md mx-auto bg-white p-6 rounded-2xl shadow-md mb-8">
    <div class="mb-4">
      <label for="mineral" class="block font-medium text-gray-700 mb-2">ค่าแร่ธาตุ (Mineral)</label>
      <input type="number" id="mineral" step="0.01" class="w-full border rounded-lg p-2">
    </div>

    <div class="mb-4">
      <label for="moisture" class="block font-medium text-gray-700 mb-2">ค่าความชื้น (Moisture)</label>
      <input type="number" id="moisture" step="0.01" class="w-full border rounded-lg p-2">
    </div>

    <div class="mb-4">
      <label for="nMineral" class="block font-medium text-gray-700 mb-2">จำนวนครั้งที่เติมแร่ธาตุต่อวัน</label>
      <input type="number" id="nMineral" min="0" class="w-full border rounded-lg p-2">
    </div>

    <div class="mb-4">
      <label for="nMoisture" class="block font-medium text-gray-700 mb-2">จำนวนครั้งที่รดน้ำต่อวัน</label>
      <input type="number" id="nMoisture" min="0" class="w-full border rounded-lg p-2">
    </div>

    <div class="flex justify-between gap-3">
      <button type="submit" class="flex-1 bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition">
        Confirm
      </button>
      <button type="button" id="cancelBtn" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700 transition">
        Cancel
      </button>
    </div>
  </form>

  <div class="grid md:grid-cols-2 gap-6 max-w-5xl mx-auto">
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <canvas id="lineChart"></canvas>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-md">
      <canvas id="barChart"></canvas>
    </div>
  </div>
</body>
</html>
